
<!DOCTYPE html>
<html>
  <head>
    <title>Golang Errors</title>
    <meta charset='utf-8'>
    <script>
      var notesEnabled =  false ;
    </script>
    <script src='/static/slides.js'></script>

    
  </head>

  <body style='display: none'>

    <section class='slides layout-widescreen'>

      <article>
        <h1>Golang Errors</h1>
        <h3>Designing application errors</h3>
        <h3>9 November 2021</h3>
        
          <div class="presenter">
            
  
  <p>
    Alex Tan Hong Pin
  </p>
  

  
  <p>
    Engineer
  </p>
  

          </div>
        
          <div class="presenter">
            
  
  <p>
    
  </p>
  

          </div>
        
      </article>

  
  
      <article >
      
        <h3>Application errors</h3>
        <p>End-users perspective:</p>
<ul>
<li>Email is invalid</li>
<li>You do not have permission to approve this. Please send an email to admin@yourcompany.com to request approval.</li>
<li>Please attach your resume before submitting.</li>
</ul>
<p>Monitoring agent perspective:</p>
<ul>
<li><code>{&quot;error&quot;: &quot;Email is invalid&quot;}</code></li>
<li>hello testing</li>
</ul>

      
      <span class="pagenumber">2</span>
      </article>
  
  
  
      <article >
      
        <h3>Error representation</h3>
        <p>The minimal field required for generic errors:</p>

  <div class="code" >
<pre><span num="24">type Error struct {</span>
<span num="25">    Kind    Kind   `json:&#34;kind&#34;`</span>
<span num="26">    Code    Code   `json:&#34;code&#34;`</span>
<span num="27">    Message string `json:&#34;message&#34;`</span>
<span num="28">    Params  M      `json:&#34;params,omitempty&#34;`</span>
<span num="29">}</span>
</pre>
</div>

      
      <span class="pagenumber">3</span>
      </article>
  
  
  
      <article >
      
        <h3>Error Kinds</h3>
        <ul>
<li><code>Kind</code> describes the breakdown of errors</li>
</ul>

  <div class="code" >
<pre><span num="6">type Kind uint</span>
<span num="7"></span>
<span num="8">//go:generate stringer -type=Kind -linecomment</span>
<span num="9">// List of error kinds.</span>
<span num="10">const (</span>
<span num="11">    Unknown            Kind = iota // unknown</span>
<span num="12">    Internal                       // internal</span>
<span num="13">    BadInput                       // bad_input</span>
<span num="14">    NotFound                       // not_found</span>
<span num="15">    AlreadyExists                  // already_exists</span>
<span num="16">    FailedPrecondition             // failed_precondition</span>
<span num="17">    Unauthorized                   // unauthorized</span>
<span num="18">    Forbidden                      // forbidden</span>
<span num="19"></span>
<span num="20">    kindEnd</span>
<span num="21">)</span>
</pre>
</div>

      
      <span class="pagenumber">4</span>
      </article>
  
  
  
      <article >
      
        <h3>Error Codes</h3>
        <ul>
<li>Unique identifier for each error type</li>
<li>Example of error codes as <code>errors.toml</code>:</li>
</ul>

  <div class="code" >
<pre><span num="1">[not_found]</span>
<span num="2">&#34;user.notFound&#34; = &#34;User not found&#34;</span>
<span num="3"></span>
<span num="4">[bad_input]</span>
<span num="5">&#34;user.invalidAge&#34; = &#34;Age must be greater than {{.MaxAge}}&#34;</span>
</pre>
</div>

      
      <span class="pagenumber">5</span>
      </article>
  
  
  
      <article >
      
        <h3>Registering Errors</h3>
        <ul>
<li><code>errors.C</code> loads errors by error code</li>
<li><code>errors.P</code> loads partial errors by error code</li>
</ul>

  <div class="code" >
<pre><span num="9">//go:embed errors.toml</span>
<span num="10">var errorCodes []byte</span>
<span num="11"></span>
<span num="12">// User errors.</span>
<span num="13">var (</span>
<span num="14">    // Register error codes before using them.</span>
<span num="15">    _ = errors.Register(errorCodes)</span>
<span num="16"></span>
<span num="17">    // Sentinel error from a given error code.</span>
<span num="18">    ErrNotFound = errors.C(&#34;user.notFound&#34;)</span>
<span num="19"></span>
<span num="20">    // A partial error from a given error code. Partial must be called with</span>
<span num="21">    // Build, in order to ensure the params are passed in for constructing the</span>
<span num="22">    // error message.</span>
<span num="23">    ErrInvalidAge = errors.P(&#34;user.invalidAge&#34;)</span>
</pre>
</div>

      
      <span class="pagenumber">6</span>
      </article>
  
  
  
      <article >
      
        <h3>Error category</h3>
        <p>Errors can generally be separated into three main category:</p>
<ul>
<li>validation errors</li>
<li>domain errors</li>
<li>internal errors</li>
</ul>

      
      <span class="pagenumber">7</span>
      </article>
  
  
  
      <article >
      
        <h3>Validation errors</h3>
        <p>When user provides a bad input</p>
<ul>
<li>missing fields on required fields (or extra fields)</li>
<li>zero values (empty string, 0 number)</li>
<li>boundaries (min/max)</li>
</ul>

      
      <span class="pagenumber">8</span>
      </article>
  
  
  
      <article >
      
        <h3>Domain errors</h3>
        <p>When business rules fails to execute</p>
<ul>
<li>invalid state transition</li>
<li>impossible states (negative balance, creating orders when out of stock,
making purchases when no balance)</li>
<li>unauthorized (lacking permission)</li>
<li>duplicate entity creation (e.g. creating two same category)</li>
</ul>
<p>May overlap a little with validation errors. Generally usecases expects inputs
to be fully sanitized and validated, hence if you find yourself duplicating
errors, you can just perform an input validation, and panic (in golang) or
throw exceptions in usecases when they appear to be invalid later (or bypassing
the initial input validation).</p>

      
      <span class="pagenumber">9</span>
      </article>
  
  
  
      <article >
      
        <h3>Internal errors</h3>
        <p>Usually technical errors such as database, network etc</p>
<ul>
<li>failed database constraints</li>
<li>trigger failure</li>
<li>failure when making HTTP requests</li>
</ul>
<p>When putting business logic in database (triggers, constraints, uniqueness, not null), you might want to translate them back to domain errors where possible.</p>

      
      <span class="pagenumber">10</span>
      </article>
  
  
  
      <article >
      
        <h3>Error JSON</h3>
        <p>Validation error:</p>
<pre><code class="language-json">{
    &quot;error&quot;: {
        &quot;kind&quot;: &quot;BAD_INPUT&quot;,
        &quot;code&quot;: &quot;account.badInput&quot;,
        &quot;message&quot;: &quot;Validation failed for account creation&quot;,
        &quot;fields&quot;: [
            {
                &quot;name&quot;: &quot;email&quot;,
                &quot;reason&quot;: &quot;Email format is invalid&quot;
            },
            {
                &quot;name&quot;: &quot;password&quot;,
                &quot;reason&quot;: &quot;Password too short&quot;
            }
        ]
    }
}
</code></pre>
<p>Failed precondition:</p>
<pre><code class="language-json">{
    &quot;error&quot;: {
        &quot;kind&quot;: &quot;FAILED_PRECONDITION&quot;,
        &quot;code&quot;: &quot;account.duplicate&quot;,
        &quot;message&quot;: &quot;An account with the email already exists&quot;
    }
}
</code></pre>

      
      <span class="pagenumber">11</span>
      </article>
  
  
  
      <article >
      
        <h3>Pre/Post-validation</h3>
        <ul>
<li>Pre: return flags that indicates something can be done</li>
<li>Post: execute, then return errors</li>
</ul>

      
      <span class="pagenumber">12</span>
      </article>
  
  
  
      <article >
      
        <h3>Errors across layers</h3>
        <ul>
<li>Database errors</li>
<li>API errors</li>
<li>conversion to and from</li>
</ul>

      
      <span class="pagenumber">13</span>
      </article>
  
  
  
      <article >
      
        <h3>Public and private errors</h3>
        <ul>
<li>Some errors should be visible to end users (aka validation error), while others not only through monitoring agent (database error, network error)</li>
<li>How to separate them?</li>
</ul>

      
      <span class="pagenumber">14</span>
      </article>
  
  
  
      <article >
      
        <h3>Fail fast or validate as whole</h3>
        <ul>
<li>Complex forms on the Frontend requires detail errors for each fields</li>
<li>Monitoring agent requires sufficient information for when errors happens</li>
<li>Fail fast: return on first error, validate as whole: return aggregated errors</li>
</ul>

      
      <span class="pagenumber">15</span>
      </article>
  
  
  
      <article >
      
        <h3>Designing errors</h3>
        <ul>
<li>Frontend Client: REST (Problem detail?) and GraphQL</li>
<li>Monitoring agent: serializable JSON errors</li>
</ul>

      
      <span class="pagenumber">16</span>
      </article>
  
  
  
      <article >
      
        <h3>Action, location and reason</h3>
        <ul>
<li>Action: failed to create user</li>
<li>Location: email</li>
<li>Reason: email is invalid</li>
</ul>

      
      <span class="pagenumber">17</span>
      </article>
  
  
  
      <article >
      
        <h3>Actionables from errors</h3>
        <ul>
<li>fix the issue</li>
<li>add more context to vague errors</li>
<li>alert on threshold exceeded</li>
<li>retries</li>
</ul>

      
      <span class="pagenumber">18</span>
      </article>
  
  
  
      <article >
      
        <h3>Tracing errors</h3>
        <ul>
<li>correlation ids</li>
<li>opentracing</li>
</ul>

      
      <span class="pagenumber">19</span>
      </article>
  
  
  
      <article >
      
        <h3>Pattern language for errors</h3>
        <ul>
<li>Important to standardize</li>
<li>Technical vs laymen</li>
<li>Noun based: Account creation failed when validating email</li>
<li>Verb based: Failed to create account/Create account failed</li>
<li>use pattern: <operation> failed at <location> because <reason>, Create account failed at email validation because email exists.</li>
</ul>

      
      <span class="pagenumber">20</span>
      </article>
  
  
  
      <article >
      
        <h3>Bulk errors</h3>
        <p>For bulk operations, like uploading CSV with thousands of rows</p>
<ul>
<li>fail fast?</li>
<li>summary of errors: n rows failed because of ...</li>
</ul>

      
      <span class="pagenumber">21</span>
      </article>
  
  

      <article>
        <h3>Thank you</h3>
        
          <div class="presenter">
            
  
  <p>
    Alex Tan Hong Pin
  </p>
  

  
  <p>
    Engineer
  </p>
  
<p class="link"><a href="mailto:alextan220990@gmail.com" target="_blank">alextan220990@gmail.com</a></p><p class="link"><a href="https://alextanhongpin.github.io/" target="_blank">https://alextanhongpin.github.io/</a></p>
          </div>
        
          <div class="presenter">
            
  
  <p>
    
  </p>
  

          </div>
        
      </article>

    </section>

    <div id="help">
      Use the left and right arrow keys or click the left and right
      edges of the page to navigate between slides.<br>
      (Press 'H' or navigate to hide this message.)
    </div>

    

  </body>
</html>
